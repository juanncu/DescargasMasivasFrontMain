<main class="main-container">
  <div class="main-title" style="color: #ab9470">DESCARGA MASIVA DE FOLIOS</div>


    <div class="info-filtros">
      <div class="filter-row">
        <div class="filter-label">Estado de cuenta:</div>
        <div class="select-wrapper">
          <select [(ngModel)]="estadoSeleccionadoId" class="custom-select">
            <option [ngValue]="null">Seleccione estado</option>
            <option *ngFor="let e of estados" [ngValue]="e.id">{{ e.nombre }}</option>
          </select>

          <div *ngIf="estadoSeleccionadoId === '3'" class="tooltip-padron">
            COBRADO, CANCELADO, CONCILIADO, CONCILIADO PARCIAL
          </div>
          <div *ngIf="estadoSeleccionadoId === '1'" class="tooltip-padron">
            COBRADO, CONCILIADO, <br> CONCILIADO PARCIAL
          </div>
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-label">Padr√≥n:</div>
        <div class="select-wrapper">
          <select [(ngModel)]="padronSeleccionadoId" class="custom-select">
            <option [ngValue]="null">Seleccione padr√≥n</option>
            <option *ngFor="let p of padrones" [ngValue]="p.id">{{ p.nombre }}</option>
          </select>

          <div *ngIf="padronSeleccionadoId === '1'" class="tooltip-padron" id="padron-tool">
            Contrato Vehicular, Contrato Obligaciones, Contrato Cr√©dito,
            Contrato Infracciones, Contrato Alcohol
          </div>
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-label">Formato:</div>
        <div class="options-group">
          <label class="checkbox-borde">
            <input type="checkbox" [(ngModel)]="formatoPdf" name="pdf"> PDF
          </label>
          <label class="checkbox-borde">
            <input type="checkbox" [(ngModel)]="formatoXml" name="xml"> XML
          </label>
          <label class="checkbox-borde">
            <input type="checkbox" [(ngModel)]="formatoRecibos" name="recibos"> Recibos
          </label>
        </div>
      </div>

      <div class="grid-meses">
        <div class="input-group">
          <label>Mes de Inicio:</label>
          <select [(ngModel)]="mesInicio" class="custom-select">
            <option *ngFor="let m of meses" [value]="m.id">{{ m.nombre }}</option>
          </select>
        </div>

        <div class="input-field">
          <div class="label-with-info">
            <label>Padr√≥n</label>
            <div class="info-icon-wrapper" *ngIf="padronSeleccionadoId === '1'">
              <mat-icon class="info-icon">info</mat-icon>
              <span class="tooltip-box">Contrato Vehicular, Obligaciones, Cr√©dito, Infracciones, Alcohol</span>
            </div>
          </div>
          <select [(ngModel)]="padronSeleccionadoId" [disabled]="descargaEnCurso" class="modern-select">
            <option value="" disabled selected>Seleccione padr√≥n</option>
            <option *ngFor="let p of padrones" [ngValue]="p.id">{{ p.nombre }}</option>
          </select>
        </div>

      <div class="input-group">
        <label>A√±o:</label>
        <select [(ngModel)]="anio" class="custom-select small-input">
          <option *ngFor="let a of aniosDisponibles" [value]="a">{{ a }}</option>
        </select>
      </div>

      <div class="input-group">
        <label class="large-label">Seleccione una Delegaci√≥n:</label>
        <select [(ngModel)]="delegacionSeleccionada" class="custom-select">
          <option *ngFor="let item of listaDelegaciones" [value]="item.delegacionID">
            {{ item.delegacion }}
          </option>
        </select>
      </div>

      <div class="button-container">
        <button (click)="buscar()" class="btn-buscar">BUSCAR</button>
      </div>
    </div>
  </section>

  <section *ngIf="resultados" class="resultados-container">
    <div class="info-header">Resultados de la b√∫squeda</div>
    <div class="info-filtros">
      <div class="resultados-grid">
        <span class="resultados-color font-bold">Archivos encontrados: {{ resultados.archivos }}</span>
        <span class="resultados-color-3 font-bold">Tama√±o aprox: {{ resultados.tamanio }}</span>
      </div>
    </div>
  </section>

  <div *ngIf="resultados" class="button-container animate-zoom" 
       style="flex-direction: column; gap: 15px; margin-top: 30px;">
    <button (click)="confirmarDescarga()" class="btn-confirmar">CONFIRMAR DESCARGA</button>
    <button (click)="simularProgreso()" class="btn-test-simulador">üß™ PROBAR BARRA (Simulaci√≥n local)</button>
  </div>

  <div *ngIf="mostrarPopupConfirmacion" class="modal-overlay">
    <div *ngIf="progreso >= 100" class="confetti-wrapper">
       </div>

    <div class="modal-content animate-zoom">
      <div class="modal-icon-circle" [style.background-color]="progreso >= 100 ? '#dcfce7' : '#f0f9ff'">
        <span [style.color]="progreso >= 100 ? '#16a34a' : '#0369a1'" class="modal-check">
          {{ progreso >= 100 ? '‚úì' : '‚¨á' }}
        </span>
      </div>

      <h2 class="modal-title italic">
        {{ progreso >= 100 ? '¬°Listo para descargar!' : '¬°Descarga en proceso!' }}
      </h2>
      <p class="modal-text">Los archivos se est√°n procesando para su descarga.</p>

      <div class="progress-section">
        <div class="progress-bg">
          <div class="progress-fill" [style.width.%]="progreso">
            <div class="shimmer-effect"></div>
          </div>
        </div>
        <div class="progress-labels">
          <span>{{ progreso }}% COMPLETADO</span>
          <span style="color: #b91c1c">‚è± {{ tiempoEstimado }}</span>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="irAlHistorial()" [disabled]="progreso < 100" class="btn-modal-red"
                [ngClass]="{'btn-disabled': progreso < 100}">
          VER DESCARGAS
        </button>
        <button (click)="reiniciarFiltros()" class="btn-modal-dark">HACER OTRA DESCARGA</button>
        <button (click)="mostrarPopupConfirmacion = false" class="btn-modal-close">Cerrar ventana</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="mostrarPopupConfirmacion">
    <div class="modal-content-gob">
      <div class="modal-header-gob">
        <h3>PROGRESO DE DESCARGA</h3>
      </div>

      <div class="modal-body-gob">

        <div class="aviso-conexion-inicial" *ngIf="cargandoMotor">
          <mat-spinner diameter="20"></mat-spinner>
          <p><strong>Conectando con el motor de descarga...</strong></p>
          <small>Esto puede tardar unos segundos si el volumen de archivos es alto.</small>
        </div>

        <div class="progress-container" [style.opacity]="cargandoMotor ? '0.5' : '1'">
          <mat-progress-bar mode="determinate" [value]="progreso"></mat-progress-bar>
          <div class="progress-text">{{ progreso }}% - {{ tiempoEstimado }}</div>
        </div>

        <div class="log-terminal">
          <div *ngFor="let log of logsDescarga" [ngClass]="'log-' + log.tipo.toLowerCase()">
            [{{ log.tipo }}] {{ log.mensaje }}
          </div>
        </div>
      </div>
    </div>
  </div>