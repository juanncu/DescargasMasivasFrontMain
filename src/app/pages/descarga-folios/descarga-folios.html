<main class="main-container">


  <div class="main-title">DESCARGA MASIVA DE FOLIOS</div>

  <section class="filter-card">
    <div class="filter-header">
      <div class="header-icon-title">
        <span class="material-icons">filter_alt</span>
        <h2>Filtros de B√∫squeda</h2>
      </div>
      <p>Seleccione los criterios para generar la descarga</p>
    </div>

    <div class="filter-body">
      <div class="selection-grid">
        <div class="input-field">
          <div class="label-with-info">
            <label>Estado de Recibo</label>
            <div class="info-icon-wrapper" *ngIf="estadoSeleccionadoId">
              <mat-icon class="info-icon">info</mat-icon>
              <span class="tooltip-box">
                {{ descripcionEstadoRecibo }}
              </span>
            </div>
          </div>

          <select [(ngModel)]="estadoSeleccionadoId" [disabled]="descargaEnCurso"
            (change)="actualizarDescripcionEstado()" class="modern-select">
            <option value="" disabled selected>Seleccione estado</option>
            <option *ngFor="let e of estados" [value]="e.id">{{ e.nombre }}</option>
          </select>
        </div>

        <div class="input-field">
          <div class="label-with-info">
            <label>Padr√≥n</label>
            <div class="info-icon-wrapper" *ngIf="padronSeleccionadoId === '1'">
              <mat-icon class="info-icon">info</mat-icon>
              <span class="tooltip-box">Contrato Vehicular, Obligaciones, Cr√©dito, Infracciones, Alcohol</span>
            </div>
          </div>
          <select [(ngModel)]="padronSeleccionadoId" [disabled]="descargaEnCurso" class="modern-select">
            <option value="" disabled selected>Seleccione padr√≥n</option>
            <option *ngFor="let p of padrones" [ngValue]="p.id">{{ p.nombre }}</option>
          </select>
        </div>

        <div class="input-field">
          <label>Formato</label>
          <div class="format-options">
            <label class="check-item"><input type="checkbox" [(ngModel)]="formatoPdf" [disabled]="descargaEnCurso">
              PDF</label>
            <label class="check-item"><input type="checkbox" [(ngModel)]="formatoXml" [disabled]="descargaEnCurso">
              XML</label>
            <label class="check-item"><input type="checkbox" [(ngModel)]="formatoRecibos" [disabled]="descargaEnCurso">
              Recibos</label>
          </div>
        </div>
      </div>

      <div class="date-grid">
        <div class="input-field">
          <label>A√ëO</label>
          <select [(ngModel)]="anio" (change)="onMesInicioChange()" class="modern-select">
            <option *ngFor="let a of aniosDisponibles" [ngValue]="a">{{ a }}</option>
          </select>
        </div>

        <div class="input-field">
          <label>MES INICIO</label>
          <select [(ngModel)]="mesInicio" (change)="onMesInicioChange()" class="modern-select">
            <option value="" disabled>Seleccione inicio</option>
            <option *ngFor="let m of mesesInicioDisponibles" [value]="m.id">{{ m.nombre }}</option>
          </select>
        </div>

        <div class="input-field">
          <label>MES FINAL</label>
          <select [(ngModel)]="mesFinal" class="modern-select" [disabled]="!mesInicio">
            <option value="" disabled>Seleccione fin</option>
            <option *ngFor="let m of mesesFinalesDisponibles" [value]="m.id">{{ m.nombre }}</option>
          </select>
        </div>
      </div>

      <div class="input-field full-width">
        <label>Delegaci√≥n</label>
        <select [(ngModel)]="delegacionSeleccionada" [disabled]="descargaEnCurso" class="modern-select">
          <option [ngValue]="null" disabled>Seleccione una delegaci√≥n</option>
          <option *ngFor="let d of listaDelegaciones" [ngValue]="d.delegacionID">
            {{ d.delegacion }}
          </option>
        </select>
      </div>

      <div class="action-footer">
        <button class="btn-buscar-modern" (click)="buscar()"
          [disabled]="!delegacionSeleccionada || !mesInicio || !mesFinal || !anio || cargando || descargaEnCurso">
          <mat-icon *ngIf="!cargando && !descargaEnCurso">search</mat-icon>
          <mat-spinner *ngIf="cargando || descargaEnCurso" diameter="20"></mat-spinner>
          {{ descargaEnCurso ? 'DESCARGA EN PROCESO' : (cargando ? 'BUSCANDO...' : 'BUSCAR DOCUMENTOS') }}
        </button>
      </div>
    </div>
  </section>

  <!-- ===== ERROR GLOBAL ===== -->
  <div *ngIf="mensajeErrorActual" class="error-ui">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <strong>{{ tipoErrorActual }}</strong>: {{ mensajeErrorActual }}
  </div>

</main>


<div class="modal-overlay" *ngIf="mostrarModalResultados">
  <div class="modal-resumen-gob">
    <div class="modal-header-gob">
      <div class="logo-container">
        <img src="assets/logo1.png" alt="Logo Gob" class="logo-gob">
      </div>
    </div>

    <div class="modal-body-gob">
      <p class="summary-text">Se han localizado los siguientes documentos seg√∫n tus filtros:</p>

      <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="stat-card" style="border-left: 3px solid #bca986;">
          <span class="stat-label">ARCHIVOS</span>
          <span class="stat-value">{{ resultados?.archivos | number }}</span>
        </div>
        <div class="stat-card" style="border-left: 3px solid #bca986;">
          <span class="stat-label">TAMA√ëO</span>
          <span class="stat-value">{{ resultados?.tamanio }}</span>
        </div>
        <div class="stat-card" style="border-left: 3px solid #bca986;">
          <span class="stat-label">TIEMPO ESTIMADO</span>
          <span class="stat-value" style="color: #8B0F28;">{{ tiempoAproxResumen }}</span>
        </div>
      </div>

      <div class="details-box-dotted">
        <strong>Periodo seleccionado:</strong>
        <span>
          {{ obtenerNombreMes(mesInicio) }} - {{ obtenerNombreMes(mesFinal) }} {{ anio }}
        </span>
      </div>
    </div>

    <div class="modal-footer-gob">
      <button class="btn-cancel-gob" (click)="cerrarModalResultados()">
        <mat-icon>close</mat-icon> CANCELAR
      </button>
      <button class="btn-confirm-gob" (click)="confirmarDescarga()">
        CONFIRMAR DESCARGA <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="mostrarPopupConfirmacion">
    <div class="modal-progreso-safin">
      <div class="modal-header-rojo">
        <h3 style="margin:0; color:white;">üì• PROCESO DE DESCARGA ACTIVO</h3>
      </div>

      <div class="modal-body-premium">
        <div class="progress-container">
          <mat-progress-bar mode="determinate" [value]="progreso"></mat-progress-bar>
          <span class="pct-text-premium">{{ tiempoEstimado }}</span>
        </div>

        <div class="controles-descarga">
          <button (click)="pausar()" class="btn-control">‚è∏ PAUSAR</button>
          <button (click)="reanudar()" class="btn-control">‚ñ∂ REANUDAR</button>
          <button (click)="cancelar()" class="btn-cancelar-gob">‚ùå CANCELAR</button>
        </div>

        <div class="log-terminal" #scrollMe [scrollTop]="scrollMe.scrollHeight">
          <div *ngFor="let log of logsDescarga"
            [ngClass]="{'txt-green': log.tipo === 'OK', 'txt-red': log.tipo === 'ERROR', 'txt-blue': log.tipo === 'ESTADO'}">
            <span *ngIf="log.tipo !== 'ESTADO'">[{{ log.tipo }}]</span> {{ log.mensaje }}
          </div>
        </div>

        <div class="modal-footer-gob" *ngIf="progreso === 100">
          <button (click)="irAlHistorial()" class="btn-confirm-gob" style="width: 100%;">
            FINALIZAR Y VER HISTORIAL
          </button>
        </div>
      </div>
    </div>





  </div>